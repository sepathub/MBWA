<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan MBWA SK Simpang Empat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (untuk JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.6s ease-out forwards; }
        
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-break { break-inside: avoid; }
            .print-hidden { display: none !important; }
            .print-bg-white { background-color: white !important; }
            .print-text-black { color: black !important; }
            .print-border-black { border-color: black !important; }
            @page { margin: 0.5cm; }
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- SETUP ---
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (SVG Direct) ---
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Printer = (props) => <Icon {...props}><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></Icon>;
        const School = (props) => <Icon {...props}><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4"/><path d="M18 5v17"/><path d="M6 5v17"/><circle cx="12" cy="9" r="2"/></Icon>;
        const User = (props) => <Icon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const MapPin = (props) => <Icon {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></Icon>;
        const Calendar = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Briefcase = (props) => <Icon {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>;
        const Smile = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const Award = (props) => <Icon {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></Icon>;
        const LayoutGrid = (props) => <Icon {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></Icon>;
        const Sun = (props) => <Icon {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></Icon>;
        const Moon = (props) => <Icon {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></Icon>;
        const Globe = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></Icon>;
        const XCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>;
        const Loader2 = (props) => <Icon {...props} className={`${props.className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>;
        const LayoutList = (props) => <Icon {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 9h7"/><path d="M14 15h7"/><path d="M14 20h7"/></Icon>;
        const PenTool = (props) => <Icon {...props}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></Icon>;
        const ArrowLeft = (props) => <Icon {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></Icon>;
        const Eye = (props) => <Icon {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></Icon>;

        // --- SUPABASE CONFIGURATION ---
        const supabaseUrl = 'https://qaleplvuyfbpjwfscdct.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhbGVwbHZ1eWZicGp3ZnNjZGN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTgxODMsImV4cCI6MjA4NTU3NDE4M30.XN8wPkQfUmqgUPOiuYVXP_I8FnY1YiWAxKU5B9Wri38';
        
        // Inisialisasi klien Supabase
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- DATA & CONSTANTS ---
        const TRANSLATIONS = {
            bm: {
                title: "Laporan MBWA",
                schoolName: "SK Simpang Empat",
                adminInfo: "Maklumat Pentadbir & Logistik",
                name: "Nama Pentadbir",
                position: "Jawatan",
                date: "Tarikh",
                time: "Masa",
                location: "Lokasi Pemantauan",
                sectionA: "Bahagian A: Skor Pemantauan",
                scoreTitle: "Skor (1-5)",
                totalScore: "Jumlah Mata",
                overall: "Pencapaian Keseluruhan",
                comments: "Bahagian B : Hal-Hal Lain",
                commentPlaceholder: "Contoh: Persekitaran kantin bersih tetapi...",
                adminSign: "Nama Pentadbir",
                witnessSign: "Tandatangan Guru Bertugas / Saksi",
                reset: "Reset",
                save: "Simpan",
                print: "Cetak / PDF",
                footer: "Pendidikan Berkualiti Insan Terdidik Negara Sejahtera",
                validationName: "Sila masukkan Nama Pentadbir sebelum menyimpan.",
                saveSuccess: "Laporan berjaya disimpan ke pangkalan data!",
                saveError: "Gagal menyimpan laporan. Sila cuba lagi.",
                dbLoading: "Sedang menyambung ke pangkalan data...",
                resetConfirm: "Adakah anda pasti? Semua data akan dipadam.",
                aspectNote: "Catatan / Ulasan",
                aspectNotePlaceholder: "Ulasan ringkas untuk aspek ini...",
                aspects: {
                    kebersihan: "Kebersihan Fizikal",
                    disiplin: "Disiplin Murid",
                    keselamatan: "Keselamatan & Infrastruktur",
                    pengurusan: "Pengurusan Bilik/Ruang",
                    keceriaan: "Keceriaan Persekitaran"
                }
            },
            en: {
                title: "MBWA Report",
                schoolName: "SK Simpang Empat",
                adminInfo: "Administrator Info & Logistics",
                name: "Administrator Name",
                position: "Position",
                date: "Date",
                time: "Time",
                location: "Observation Location",
                sectionA: "Section A: Observation Score",
                scoreTitle: "Score (1-5)",
                totalScore: "Total Points",
                overall: "Overall Achievement",
                comments: "Section B : Other Matters",
                commentPlaceholder: "Example: Canteen environment is clean but...",
                adminSign: "Administrator Name",
                witnessSign: "Duty Teacher / Witness Signature",
                reset: "Reset",
                save: "Save",
                print: "Print / PDF",
                footer: "Quality Education, Educated People, Prosperous Nation",
                validationName: "Please enter Administrator Name before saving.",
                saveSuccess: "Report saved to database successfully!",
                saveError: "Failed to save report. Please try again.",
                dbLoading: "Connecting to database...",
                resetConfirm: "Are you sure? All data will be cleared.",
                aspectNote: "Notes / Comments",
                aspectNotePlaceholder: "Brief comments for this aspect...",
                aspects: {
                    kebersihan: "Physical Cleanliness",
                    disiplin: "Student Discipline",
                    keselamatan: "Safety & Infrastructure",
                    pengurusan: "Room/Space Management",
                    keceriaan: "Environment Cheerfulness"
                }
            }
        };

        const ASPEK_PENILAIAN = [
            { id: 'kebersihan', icon: <RefreshCw size={20} className="text-teal-600" /> },
            { id: 'disiplin', icon: <User size={20} className="text-indigo-600" /> },
            { id: 'keselamatan', icon: <CheckCircle size={20} className="text-red-600" /> },
            { id: 'pengurusan', icon: <Briefcase size={20} className="text-orange-600" /> },
            { id: 'keceriaan', icon: <Smile size={20} className="text-pink-600" /> }
        ];

        const ADMIN_LIST = [
            "ANUAR BIN ISMAIL",
            "ROSNIZAN BINTI ABD RANI",
            "HANIZA BINTI SEDIN",
            "MUHAMMAD DANIAL BIN JAMALUDIN",
            "SUZANA BINTI SULAIMAN"
        ];

        const LOCATION_LIST = [
            "Kelas",
            "Bilik Khas",
            "Kawasan Lain",
            "Tandas"
        ];

        // --- COMPONENTS ---

        const Toast = ({ message, type = 'success', isVisible, onClose }) => {
            if (!isVisible) return null;
            const isError = type === 'error';
            return (
                <div className="fixed top-5 right-5 z-50 animate-bounce-in print:hidden">
                    <div className={`border-l-4 ${isError ? 'border-red-500' : 'border-green-500'} bg-white text-slate-700 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3`}>
                        {isError ? <XCircle className="text-red-500" size={24} /> : <CheckCircle className="text-green-500" size={24} />}
                        <div>
                            <h4 className="font-bold text-sm">{isError ? 'Ralat' : 'Berjaya!'}</h4>
                            <p className="text-xs text-slate-500">{message}</p>
                        </div>
                        <button onClick={onClose} className="ml-4 text-slate-400 hover:text-slate-600 font-bold">✕</button>
                    </div>
                </div>
            );
        };

        const HeaderSection = ({ t, isDarkMode }) => (
            <div className="bg-gradient-to-r from-blue-900 via-blue-700 to-blue-500 text-white p-6 relative print:bg-white print:text-black print:border-b-2 print:border-black print:p-0 print:pb-4 print:mb-6">
                <div className="absolute top-0 right-0 p-4 opacity-10 print:hidden pointer-events-none"><School size={120} /></div>
                <div className="flex items-center gap-6 relative z-10 print:gap-4">
                    <div className={`p-3 rounded-2xl text-blue-900 shadow-lg print:border-2 print:border-black print:shadow-none print:p-2 print:rounded-full ${isDarkMode ? 'bg-slate-200' : 'bg-white/95'}`}>
                        <img 
                            src="https://i.postimg.cc/V6LnHkFk/LOGO_SKSE_utk_background_putih_(2).jpg" 
                            alt="Logo Sekolah" 
                            className="w-16 h-16 object-contain print:w-16 print:h-16"
                        />
                    </div>
                    <div className="flex-1">
                        <h1 className="text-3xl font-extrabold uppercase tracking-wider drop-shadow-sm print:text-2xl print:text-black">{t.schoolName}</h1>
                        <p className="text-blue-100 text-sm font-medium print:text-gray-600 mt-1 print:text-xs">Kod Sekolah: MBA0022 | Tel: 06-552 8803</p>
                        <div className="mt-3 inline-flex items-center gap-2 bg-yellow-400 text-blue-900 px-3 py-1 rounded-full text-sm font-bold shadow-sm print:bg-transparent print:text-black print:p-0 print:shadow-none print:mt-1 uppercase print:border print:border-black print:px-2">
                            <Award size={14} className="print:hidden"/> {t.title}
                        </div>
                    </div>
                </div>
            </div>
        );

        const AdminInfoForm = ({ formData, updateField, t, isDarkMode }) => (
            <section className={`p-6 rounded-2xl border shadow-sm transition-all hover:shadow-md print:border-none print:shadow-none print:p-0 ${isDarkMode ? 'bg-slate-700/50 border-slate-600' : 'bg-blue-50/60 border-blue-100'}`}>
                <h3 className={`text-lg font-bold mb-6 flex items-center gap-2 border-b pb-2 print:border-none print:mb-2 print:text-black ${isDarkMode ? 'text-blue-300 border-slate-600' : 'text-blue-800 border-blue-200'}`}>
                    <span className={`p-1.5 rounded-lg print:hidden ${isDarkMode ? 'bg-slate-600 text-blue-300' : 'bg-blue-100 text-blue-600'}`}><User size={18} /></span>
                    {t.adminInfo}
                </h3>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 print:gap-4 print:text-sm">
                    <div className="space-y-2">
                        <label className={`text-xs font-bold uppercase tracking-wider flex items-center gap-2 print:text-black ${isDarkMode ? 'text-blue-300' : 'text-blue-600'}`}>
                            <User size={14} className="print:hidden"/> {t.name}
                        </label>
                        <div className="relative">
                            <select 
                                name="namaPentadbir" 
                                value={formData.namaPentadbir}
                                onChange={(e) => updateField('namaPentadbir', e.target.value)}
                                className={`w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 appearance-none print:border-none print:p-0 print:font-bold print:bg-transparent cursor-pointer ${isDarkMode ? 'bg-slate-800 border-slate-600 text-white hover:bg-slate-700' : 'bg-white border-blue-200 hover:bg-blue-50'}`}
                            >
                                <option value="">Sila Pilih Nama...</option>
                                {ADMIN_LIST.map((name) => (
                                    <option key={name} value={name}>{name}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className={`text-xs font-bold uppercase tracking-wider flex items-center gap-2 print:text-black ${isDarkMode ? 'text-blue-300' : 'text-blue-600'}`}>
                            <Briefcase size={14} className="print:hidden"/> {t.position}
                        </label>
                        <div className="relative">
                            <select 
                                name="jawatan" value={formData.jawatan}
                                onChange={(e) => updateField('jawatan', e.target.value)}
                                className={`w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 appearance-none print:border-none print:p-0 print:font-bold print:bg-transparent cursor-pointer ${isDarkMode ? 'bg-slate-800 border-slate-600 text-white hover:bg-slate-700' : 'bg-white border-blue-200 hover:bg-blue-50'}`}
                            >
                                <option value="Guru Besar">Guru Besar</option>
                                <option value="PK Pentadbiran">PK Pentadbiran</option>
                                <option value="PK Hal Ehwal Murid">PK Hal Ehwal Murid</option>
                                <option value="PK Kokurikulum">PK Kokurikulum</option>
                                <option value="PK PPKI">PK PPKI</option>
                            </select>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className={`text-xs font-bold uppercase tracking-wider flex items-center gap-2 print:text-black ${isDarkMode ? 'text-blue-300' : 'text-blue-600'}`}>
                            <Calendar size={14} className="print:hidden"/> {t.date}
                        </label>
                        <input 
                            type="date" name="tarikh" value={formData.tarikh}
                            onChange={(e) => updateField('tarikh', e.target.value)}
                            className={`w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 print:border-none print:p-0 print:bg-transparent ${isDarkMode ? 'bg-slate-800 border-slate-600 text-white' : 'bg-white border-blue-200'}`}
                        />
                    </div>

                    <div className="space-y-2">
                        <label className={`text-xs font-bold uppercase tracking-wider flex items-center gap-2 print:text-black ${isDarkMode ? 'text-blue-300' : 'text-blue-600'}`}>
                            <Clock size={14} className="print:hidden"/> {t.time}
                        </label>
                        <input 
                            type="time" name="masa" value={formData.masa}
                            onChange={(e) => updateField('masa', e.target.value)}
                            className={`w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 print:border-none print:p-0 print:bg-transparent ${isDarkMode ? 'bg-slate-800 border-slate-600 text-white' : 'bg-white border-blue-200'}`}
                        />
                    </div>

                    <div className="col-span-1 md:col-span-2 space-y-2">
                        <label className={`text-xs font-bold uppercase tracking-wider flex items-center gap-2 print:text-black ${isDarkMode ? 'text-blue-300' : 'text-blue-600'}`}>
                            <MapPin size={14} className="print:hidden"/> {t.location}
                        </label>
                        <div className="relative">
                            <select
                                name="lokasi"
                                value={formData.lokasi}
                                onChange={(e) => updateField('lokasi', e.target.value)}
                                className={`w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 appearance-none print:border-none print:p-0 print:font-bold print:bg-transparent cursor-pointer ${isDarkMode ? 'bg-slate-800 border-slate-600 text-white hover:bg-slate-700' : 'bg-white border-blue-200 hover:bg-blue-50'}`}
                            >
                                <option value="">Sila Pilih Lokasi...</option>
                                {LOCATION_LIST.map((loc) => (
                                    <option key={loc} value={loc}>{loc}</option>
                                ))}
                            </select>
                        </div>

                        {/* Input Tambahan untuk Catatan */}
                        {["Kawasan Lain", "Kelas", "Bilik Khas", "Tandas"].includes(formData.lokasi) && (
                            <div className="mt-2 animate-enter">
                                <input 
                                    type="text" 
                                    name="lokasiCatatan" 
                                    value={formData.lokasiCatatan || ''}
                                    onChange={(e) => updateField('lokasiCatatan', e.target.value)}
                                    placeholder={
                                        formData.lokasi === "Kelas" ? "Sila nyatakan nama kelas..." : 
                                        formData.lokasi === "Bilik Khas" ? "Sila nyatakan nama bilik khas..." :
                                        formData.lokasi === "Tandas" ? "Sila nyatakan lokasi tandas..." :
                                        "Sila nyatakan kawasan..."
                                    }
                                    className={`w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 transition-all print:border-none print:p-0 print:font-bold print:bg-transparent ${isDarkMode ? 'bg-slate-800 border-slate-600 text-white' : 'bg-white border-blue-200'}`}
                                />
                            </div>
                        )}
                    </div>
                </div>
            </section>
        );

        const ScoreTable = ({ formData, updateScore, updateAspectComment, t, isDarkMode, calculations }) => {
            const { totalScore, maxScore, percentage } = calculations;
            
            const getProgressColor = (percent) => {
                if (percent > 80) return 'bg-green-500';
                if (percent > 50) return 'bg-yellow-400';
                return 'bg-red-400';
            };

            return (
                <section className={`p-6 rounded-2xl border shadow-sm transition-all hover:shadow-md print:border-none print:shadow-none print:p-0 ${isDarkMode ? 'bg-slate-700/50 border-slate-600' : 'bg-indigo-50/60 border-indigo-100'}`}>
                    <div className={`mb-6 border-b pb-4 print:border-none print:mb-4 ${isDarkMode ? 'border-slate-600' : 'border-indigo-200'}`}>
                        <div className="flex justify-between items-center mb-3">
                            <h3 className={`text-lg font-bold flex items-center gap-2 print:text-black ${isDarkMode ? 'text-indigo-300' : 'text-indigo-900'}`}>
                                <span className={`p-1.5 rounded-lg print:hidden ${isDarkMode ? 'bg-slate-600 text-indigo-300' : 'bg-indigo-100 text-indigo-600'}`}><LayoutGrid size={18} /></span>
                                {t.sectionA}
                            </h3>
                        </div>
                        
                        <div className={`w-full rounded-full h-3 mb-2 print:hidden ${isDarkMode ? 'bg-slate-600' : 'bg-slate-200'}`}>
                            <div className={`h-3 rounded-full transition-all duration-500 ${getProgressColor(percentage)}`} style={{ width: `${percentage}%` }}></div>
                        </div>
                        <p className={`text-sm text-right font-medium print:hidden ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                            {percentage}% {t.overall}
                        </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 print:grid-cols-2 print:gap-x-8 print:gap-y-2">
                        {ASPEK_PENILAIAN.map((item) => {
                            const score = formData.skor[item.id];
                            const comment = formData.catatanBahagianA?.[item.id] || '';
                            const label = t.aspects[item.id];
                            
                            let sliderColorClass = "accent-green-500";
                            if (score <= 2) sliderColorClass = "accent-red-500";
                            else if (score === 3) sliderColorClass = "accent-yellow-500";

                            let boxColorClass = isDarkMode 
                                ? (score > 3 ? "border-green-500 text-green-400" : score === 3 ? "border-yellow-500 text-yellow-400" : "border-red-500 text-red-400")
                                : (score > 3 ? "border-green-200 bg-green-50 text-green-600" : score === 3 ? "border-yellow-200 bg-yellow-50 text-yellow-600" : "border-red-200 bg-red-50 text-red-600");

                            return (
                                <div key={item.id} className={`p-4 rounded-xl border flex flex-col justify-between shadow-sm hover:shadow-md transition-all print:border print:border-gray-300 print:p-2 print:shadow-none print:break-inside-avoid ${isDarkMode ? 'bg-slate-800 border-slate-600' : 'bg-white border-indigo-100'}`}>
                                    <div className="flex items-start gap-3 mb-3 print:mb-1">
                                        <div className={`p-2 rounded-lg shrink-0 print:hidden ${isDarkMode ? 'bg-slate-700' : 'bg-indigo-50'}`}>{item.icon}</div>
                                        <div><span className={`text-sm font-semibold print:text-black ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`}>{label}</span></div>
                                    </div>
                                    
                                    <div className="flex items-center gap-3 mb-3">
                                        <input 
                                            type="range" min="1" max="5" value={score}
                                            onChange={(e) => updateScore(item.id, e.target.value)}
                                            className={`w-full h-2 rounded-lg appearance-none cursor-pointer print:hidden bg-slate-200 ${sliderColorClass}`}
                                        />
                                        <div className={`w-10 h-10 flex items-center justify-center font-bold rounded-lg border text-lg transition-colors print:border-none print:w-auto print:h-auto print:text-black print:bg-transparent ${boxColorClass}`}>
                                            {score}
                                        </div>
                                    </div>

                                    {/* Ruang Catatan Per Aspek */}
                                    <div className="mt-2 pt-2 border-t border-dashed border-gray-200 print:border-gray-400">
                                        <label className={`text-xs font-semibold mb-1 block flex items-center gap-1 print:text-black ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                                            <MessageSquare size={10} className="print:hidden"/> {t.aspectNote}:
                                        </label>
                                        <input 
                                            type="text"
                                            value={comment}
                                            onChange={(e) => updateAspectComment(item.id, e.target.value)}
                                            placeholder={t.aspectNotePlaceholder}
                                            className={`w-full text-xs p-2 rounded-lg border focus:ring-1 focus:ring-blue-300 transition-all print:border-none print:p-0 print:bg-transparent print:text-xs print:italic ${isDarkMode ? 'bg-slate-900 border-slate-600 text-slate-300' : 'bg-slate-50 border-slate-200 text-slate-700'}`}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className={`mt-6 pt-4 border-t flex justify-between items-center print:mt-4 print:border-black ${isDarkMode ? 'border-slate-600' : 'border-indigo-200'}`}>
                        <span className={`font-bold uppercase text-sm print:text-black ${isDarkMode ? 'text-indigo-300' : 'text-indigo-900'}`}>{t.totalScore}</span>
                        <span className={`font-bold text-lg print:text-black ${isDarkMode ? 'text-indigo-300' : 'text-indigo-900'}`}>{totalScore} / {maxScore}</span>
                    </div>
                </section>
            );
        };

        const CommentsSection = ({ formData, updateField, t, isDarkMode }) => (
            <section className={`p-6 rounded-2xl border shadow-sm transition-all hover:shadow-md print:border-none print:shadow-none print:p-0 ${isDarkMode ? 'bg-slate-700/50 border-slate-600' : 'bg-green-50/60 border-green-100'}`}>
                <h3 className={`text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2 print:border-none print:mb-2 print:text-black ${isDarkMode ? 'text-green-300 border-slate-600' : 'text-green-800 border-green-200'}`}>
                    <span className={`p-1.5 rounded-lg print:hidden ${isDarkMode ? 'bg-slate-600 text-green-300' : 'bg-green-100 text-green-600'}`}><FileText size={18} /></span>
                    {t.comments}
                </h3>
                <div className={`p-1 rounded-xl border shadow-inner print:border-black print:p-0 print:shadow-none focus-within:ring-2 focus-within:ring-green-400 transition-shadow ${isDarkMode ? 'bg-slate-800 border-slate-600' : 'bg-white border-green-200'}`}>
                    <textarea
                        name="ulasan" value={formData.ulasan}
                        onChange={(e) => updateField('ulasan', e.target.value)}
                        rows="6" maxLength={500} placeholder={t.commentPlaceholder}
                        className={`w-full p-4 rounded-lg focus:ring-0 focus:outline-none resize-none leading-relaxed bg-transparent print:text-sm print:h-40 ${isDarkMode ? 'text-slate-100 placeholder-slate-500' : 'text-slate-700 placeholder-slate-400'}`}
                    ></textarea>
                </div>
                <div className="flex justify-end mt-2 print:hidden">
                    <span className={`text-xs font-semibold ${formData.ulasan.length > 450 ? 'text-red-500' : 'text-slate-400'}`}>{formData.ulasan.length} / 500</span>
                </div>
            </section>
        );

        const FooterSection = ({ formData, actions, t, isDarkMode }) => (
            <React.Fragment>
                <div className="hidden print:flex justify-between items-end mt-12 pt-12 no-break">
                    <div className="text-center w-5/12">
                        <div className="h-20 flex flex-col justify-end">
                            <p className="font-bold text-sm">{t.adminSign}</p>
                        </div>
                        <p className="text-sm font-bold uppercase mt-1">({formData.namaPentadbir || '____________________'})</p>
                        <p className="text-xs mt-1">{formData.jawatan}</p>
                    </div>

                    <div className="text-center w-5/12">
                        <div className="h-20 border-b border-black border-dotted mb-2 mx-auto w-full"></div>
                        <p className="font-bold text-sm">{t.witnessSign}</p>
                        <p className="text-xs italic uppercase mt-1">(____________________)</p>
                        <p className="text-xs mt-1">{t.date}: {new Date(formData.tarikh).toLocaleDateString('ms-MY')}</p>
                    </div>
                </div>
                
                <div className="hidden print:block text-center mt-12 pt-4 border-t border-gray-300">
                    <p className="text-xs font-serif italic text-gray-500">"{t.footer}"</p>
                </div>
            </React.Fragment>
        );

        const ActionButtons = ({ actions, t, isDarkMode, isSaving }) => (
            <div className={`p-6 flex flex-wrap justify-end gap-3 border-t print:hidden ${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-gray-50 border-gray-100'}`}>
                <button onClick={actions.handleReset} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all hover:scale-105 active:scale-95 font-semibold ${isDarkMode ? 'bg-slate-600 text-slate-200 hover:bg-slate-500' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>
                    <RefreshCw size={18} /> {t.reset}
                </button>
                <button 
                    onClick={actions.handleSave} 
                    disabled={isSaving}
                    className={`flex items-center gap-2 px-5 py-2.5 text-white rounded-xl shadow-lg transition-transform duration-200 font-semibold active:scale-95 ${isSaving ? 'bg-green-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 hover:scale-105'}`}
                >
                    {isSaving ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />} 
                    {isSaving ? 'Menyimpan...' : t.save}
                </button>
                <button 
                    onClick={() => window.print()} 
                    title="Cetak atau Simpan sebagai PDF"
                    className="flex items-center gap-2 px-6 py-2.5 text-white bg-gradient-to-r from-blue-700 to-blue-500 rounded-xl hover:from-blue-800 hover:to-blue-600 hover:shadow-lg hover:scale-105 transition-transform duration-200 font-semibold active:scale-95"
                >
                    <Printer size={18} /> {t.print}
                </button>
            </div>
        );

        // --- NEW REPORT LIST TAB COMPONENT ---
        const ReportListComponent = ({ onSelectReport, t, isDarkMode }) => {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                fetchReports();
            }, [selectedDate]);

            const fetchReports = async () => {
                setLoading(true);
                const { data, error } = await supabase
                    .from('laporan_mbwa')
                    .select('*')
                    .eq('tarikh', selectedDate)
                    .order('masa', { ascending: true });
                
                if (error) console.error("Error fetching reports:", error);
                else setReports(data || []);
                setLoading(false);
            };

            const mapDbToState = (dbRecord) => ({
                namaPentadbir: dbRecord.nama_pentadbir,
                jawatan: dbRecord.jawatan,
                tarikh: dbRecord.tarikh,
                masa: dbRecord.masa,
                lokasi: dbRecord.lokasi,
                lokasiCatatan: dbRecord.lokasi_catatan,
                skor: dbRecord.skor,
                catatanBahagianA: dbRecord.catatan_bahagian_a || { kebersihan: '', disiplin: '', keselamatan: '', pengurusan: '', keceriaan: '' },
                ulasan: dbRecord.ulasan
            });

            return (
                <div className={`p-6 space-y-6 ${isDarkMode ? 'text-white' : 'text-slate-700'}`}>
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold flex items-center gap-2">
                            <LayoutList size={24} className="text-blue-500"/> Senarai Cetakan Laporan
                        </h2>
                    </div>

                    <div className="flex items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700">
                        <label className="font-semibold text-sm">Pilih Tarikh:</label>
                        <input 
                            type="date" 
                            value={selectedDate} 
                            onChange={(e) => setSelectedDate(e.target.value)}
                            className={`p-2 border rounded-lg ${isDarkMode ? 'bg-slate-700 border-slate-600 text-white' : 'bg-slate-50 border-slate-300'}`}
                        />
                    </div>

                    {loading ? (
                        <div className="flex justify-center py-10"><Loader2 size={40} className="animate-spin text-blue-500"/></div>
                    ) : reports.length === 0 ? (
                        <div className="text-center py-10 opacity-50 border-2 border-dashed border-slate-300 rounded-xl">
                            <p>Tiada laporan dijumpai pada tarikh ini.</p>
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {reports.map((report) => (
                                <div key={report.id} className={`p-4 rounded-xl border flex justify-between items-center shadow-sm hover:shadow-md transition-all ${isDarkMode ? 'bg-slate-800 border-slate-600' : 'bg-white border-blue-100 hover:bg-blue-50'}`}>
                                    <div>
                                        <p className="font-bold text-lg">{report.nama_pentadbir}</p>
                                        <p className="text-sm opacity-70 flex items-center gap-2">
                                            <Clock size={14}/> {report.masa} &nbsp;|&nbsp; <MapPin size={14}/> {report.lokasi}
                                        </p>
                                    </div>
                                    <button 
                                        onClick={() => onSelectReport(mapDbToState(report))}
                                        className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 shadow-sm font-medium text-sm"
                                    >
                                        <Eye size={16}/> Papar & Cetak
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const MBWAReport = () => {
            const getInitialData = () => {
                return {
                    namaPentadbir: '',
                    jawatan: 'Guru Besar',
                    tarikh: new Date().toISOString().split('T')[0],
                    masa: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    lokasi: '',
                    lokasiCatatan: '',
                    skor: { kebersihan: 4, disiplin: 5, keselamatan: 4, pengurusan: 5, keceriaan: 3 },
                    catatanBahagianA: { kebersihan: '', disiplin: '', keselamatan: '', pengurusan: '', keceriaan: '' },
                    ulasan: ''
                };
            };

            const [activeTab, setActiveTab] = useState('input'); // 'input' or 'list'
            const [formData, setFormData] = useState(getInitialData);
            const [lang, setLang] = useState('bm');
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [isSaving, setIsSaving] = useState(false);

            const t = TRANSLATIONS[lang];

            // Functions for managing form data
            const updateField = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const updateScore = (id, value) => setFormData(prev => ({...prev, skor: {...prev.skor, [id]: parseInt(value)}}));
            const updateAspectComment = (id, value) => setFormData(prev => ({...prev, catatanBahagianA: {...prev.catatanBahagianA, [id]: value}}));
            const handleReset = () => { if(window.confirm(t.resetConfirm)) setFormData(getInitialData()); };
            
            const handleSave = async () => {
                if (!formData.namaPentadbir.trim()) { showToast(t.validationName, 'error'); return; }
                setIsSaving(true);
                try {
                    const { error } = await supabase.from('laporan_mbwa').insert([{
                        nama_pentadbir: formData.namaPentadbir,
                        jawatan: formData.jawatan,
                        tarikh: formData.tarikh,
                        masa: formData.masa,
                        lokasi: formData.lokasi,
                        lokasi_catatan: formData.lokasiCatatan,
                        skor: formData.skor,
                        catatan_bahagian_a: formData.catatanBahagianA,
                        ulasan: formData.ulasan
                    }]);
                    if (error) throw error;
                    showToast(t.saveSuccess, 'success');
                } catch (error) { console.error('Ralat:', error); showToast(`${t.saveError} (${error.message})`, 'error'); } 
                finally { setIsSaving(false); }
            };

            const showToast = (message, type = 'success') => { setToast({ show: true, message, type }); setTimeout(() => setToast(prev => ({ ...prev, show: false })), 4000); };
            const calculations = useMemo(() => {
                const totalScore = Object.values(formData.skor).reduce((a, b) => a + b, 0);
                const maxScore = ASPEK_PENILAIAN.length * 5;
                const percentage = Math.round((totalScore / maxScore) * 100);
                return { totalScore, maxScore, percentage };
            }, [formData.skor]);

            const loadReportForPrinting = (data) => {
                setFormData(data);
                setActiveTab('input'); // Switch back to form view to show details
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showToast("Laporan dimuatkan. Sila tekan butang Cetak di bawah.", "success");
            };

            const actions = { setLang, setIsDarkMode, setToast: showToast, closeToast: () => setToast(prev => ({ ...prev, show: false })), updateField, updateScore, updateAspectComment, handleSave, handleReset };

            return (
                <React.Fragment>
                    <Toast message={toast.message} type={toast.type} isVisible={toast.show} onClose={actions.closeToast} />

                    <div className={`min-h-screen p-4 md:p-8 transition-colors duration-500 ease-in-out ${isDarkMode ? 'bg-slate-900 text-slate-100' : 'bg-sky-50 text-slate-700'}`}>
                        
                        {/* Global Controls */}
                        <div className="fixed top-4 right-4 z-40 flex gap-2 print:hidden">
                            <button onClick={() => setLang(l => l === 'bm' ? 'en' : 'bm')} className={`p-2 rounded-full shadow-lg ${isDarkMode ? 'bg-slate-800 text-white' : 'bg-white text-slate-700'}`}><Globe size={16}/></button>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full shadow-lg ${isDarkMode ? 'bg-yellow-400 text-slate-900' : 'bg-slate-700 text-white'}`}>{isDarkMode ? <Sun size={18}/> : <Moon size={18}/>}</button>
                        </div>

                        {/* Main Container */}
                        <div className={`max-w-[210mm] mx-auto shadow-2xl rounded-2xl overflow-hidden animate-enter transition-colors duration-300 print:shadow-none print:max-w-full print:rounded-none ${isDarkMode ? 'bg-slate-800' : 'bg-white'}`}>
                            
                            <HeaderSection t={t} isDarkMode={isDarkMode} />

                            {/* TAB NAVIGATION (Hidden in Print) */}
                            <div className="flex border-b border-gray-200 print:hidden">
                                <button 
                                    onClick={() => setActiveTab('input')}
                                    className={`flex-1 py-3 font-bold text-sm flex items-center justify-center gap-2 transition-colors ${activeTab === 'input' ? (isDarkMode ? 'bg-slate-700 text-blue-400 border-b-2 border-blue-400' : 'bg-blue-50 text-blue-600 border-b-2 border-blue-600') : (isDarkMode ? 'text-slate-400 hover:bg-slate-700' : 'text-slate-500 hover:bg-slate-50')}`}
                                >
                                    <PenTool size={16}/> Borang Baru / Paparan
                                </button>
                                <button 
                                    onClick={() => setActiveTab('list')}
                                    className={`flex-1 py-3 font-bold text-sm flex items-center justify-center gap-2 transition-colors ${activeTab === 'list' ? (isDarkMode ? 'bg-slate-700 text-blue-400 border-b-2 border-blue-400' : 'bg-blue-50 text-blue-600 border-b-2 border-blue-600') : (isDarkMode ? 'text-slate-400 hover:bg-slate-700' : 'text-slate-500 hover:bg-slate-50')}`}
                                >
                                    <LayoutList size={16}/> Senarai Cetakan
                                </button>
                            </div>
                            
                            {/* CONTENT AREA */}
                            {activeTab === 'input' ? (
                                <React.Fragment>
                                    <div className="p-8 space-y-8 print:p-0 print:space-y-6">
                                        <AdminInfoForm formData={formData} updateField={actions.updateField} t={t} isDarkMode={isDarkMode} />
                                        <ScoreTable formData={formData} updateScore={actions.updateScore} updateAspectComment={actions.updateAspectComment} t={t} isDarkMode={isDarkMode} calculations={calculations} />
                                        <CommentsSection formData={formData} updateField={actions.updateField} t={t} isDarkMode={isDarkMode} />
                                        <FooterSection formData={formData} actions={actions} t={t} isDarkMode={isDarkMode} />
                                    </div>
                                    <ActionButtons actions={actions} t={t} isDarkMode={isDarkMode} isSaving={isSaving} />
                                </React.Fragment>
                            ) : (
                                <ReportListComponent onSelectReport={loadReportForPrinting} t={t} isDarkMode={isDarkMode} />
                            )}
                        </div>
                        
                        <div className="text-center mt-8 text-blue-300 text-sm print:hidden font-medium opacity-60">Sistem Pengurusan Sekolah Digital © 2026</div>
                    </div>
                </React.Fragment>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MBWAReport />);
    </script>
</body>
</html>
